name: Dependency Updates

on:
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  update-dependencies:
    name: Update Python Dependencies
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install pip-tools
      run: pip install pip-tools
      
    - name: Update main requirements
      run: |
        if [ -f requirements.txt ]; then
          if [ -f requirements.in ]; then
            pip-compile --upgrade requirements.in
          else
            cp requirements.txt requirements.in
            pip-compile --upgrade requirements.in
          fi
        fi
        
    - name: Update API requirements
      run: |
        if [ -f api/requirements.txt ]; then
          cd api
          if [ -f requirements.in ]; then
            pip-compile --upgrade requirements.in
          else
            cp requirements.txt requirements.in
            pip-compile --upgrade requirements.in
          fi
        fi
        
    - name: Update Dashboard requirements
      run: |
        if [ -f dashboard/requirements.txt ]; then
          cd dashboard
          if [ -f requirements.in ]; then
            pip-compile --upgrade requirements.in
          else
            cp requirements.txt requirements.in
            pip-compile --upgrade requirements.in
          fi
        fi
        
    - name: Update MLflow requirements
      run: |
        if [ -f mlflow/requirements.txt ]; then
          cd mlflow
          if [ -f requirements.in ]; then
            pip-compile --upgrade requirements.in
          else
            cp requirements.txt requirements.in
            pip-compile --upgrade requirements.in
          fi
        fi
        
    - name: Test updated dependencies
      run: |
        pip install -r requirements.txt || true
        if [ -f api/requirements.txt ]; then pip install -r api/requirements.txt || true; fi
        if [ -f dashboard/requirements.txt ]; then pip install -r dashboard/requirements.txt || true; fi
        if [ -f mlflow/requirements.txt ]; then pip install -r mlflow/requirements.txt || true; fi
        
        python -c "
        try:
            import pandas, numpy, sklearn, fastapi, mlflow
            print('‚úÖ Basic imports successful')
        except ImportError as e:
            print(f'‚ùå Import error: {e}')
            exit(1)
        "
        
    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'chore: update Python dependencies'
        title: 'üîÑ Weekly Dependency Updates'
        body: |
          ## Automated Dependency Updates
          
          This PR contains automated updates to Python dependencies.
          
          ### Changes
          - Updated all requirements.txt files with latest compatible versions
          - Maintained compatibility with existing codebase
          
          ### Testing
          - [x] Basic import tests passed
          - [ ] Full CI pipeline will run automatically
          
          ### Review Checklist
          - [ ] Check for any breaking changes in updated packages
          - [ ] Verify all tests pass
          - [ ] Review security advisories for updated packages
          
          **Auto-generated by dependency update workflow**
        branch: dependency-updates
        delete-branch: true
        
    - name: Check for security updates
      run: |
        pip install safety
        safety check || echo "Security issues found - please review"
